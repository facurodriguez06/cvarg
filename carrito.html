<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tu Carrito | CV Arg</title>
    <link rel="icon" href="img/logo.png" type="image/png" />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      /* --- VARIABLES --- */
      :root {
        --primary-blue: #044bab;
        --primary-dark: #022a61;
        --accent-yellow: #f3d136;
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --white: #ffffff;
        --bg-light: #f8fafc;
        --success: #10b981;
        --danger: #ef4444;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
        scroll-behavior: smooth;
      }
      body {
        background-color: var(--bg-light);
        color: var(--text-dark);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* NAVBAR */
      nav {
        position: fixed;
        top: 0;
        width: 100%;
        padding: 1.5rem 5% 0 5%;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        z-index: 1000;
        transition: all 0.4s ease;
        background: transparent;
      }
      nav.scrolled {
        background: var(--primary-blue);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        padding-bottom: 1rem;
      }

      .logo {
        display: flex;
        align-items: center;
        text-decoration: none;
        margin-top: -10px;
      }
      .logo-img {
        height: 100px;
        width: auto;
        object-fit: contain;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 30px;
        margin-top: 25px;
      }
      .nav-links {
        display: flex;
        gap: 30px;
        list-style: none;
        margin: 0;
      }
      .nav-links a {
        text-decoration: none;
        color: var(--white);
        font-weight: 500;
        font-size: 1.1rem;
        transition: 0.3s;
        opacity: 0.9;
      }
      .nav-links a:hover,
      .nav-links a.active {
        opacity: 1;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }
      .nav-links a.active {
        border-bottom: 3px solid var(--accent-yellow);
      }

      .cart-wrapper {
        position: relative;
        cursor: pointer;
        color: var(--white);
        font-size: 1.4rem;
        text-decoration: none;
      }
      .cart-count {
        position: absolute;
        top: -8px;
        right: -10px;
        background: var(--accent-yellow);
        color: var(--primary-dark);
        font-size: 0.75rem;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 800;
      }

      /* HEADER SIMPLE */
      .page-header {
        padding: 160px 5% 80px;
        background: var(--primary-blue);
        color: var(--white);
        text-align: center;
        clip-path: polygon(0 0, 100% 0, 100% 90%, 0 100%);
        margin-bottom: 0;
      }
      .page-title {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 10px;
        animation: fadeDown 0.8s ease;
      }
      .page-subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
        animation: fadeDown 0.8s ease 0.2s backwards;
      }

      /* LAYOUT CARRITO */
      .cart-section {
        max-width: 1200px;
        margin: 40px auto 80px;
        padding: 0 5%;
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 40px;
        animation: fadeUp 0.8s ease backwards 0.4s;
      }

      /* LISTA DE ITEMS */
      .cart-items {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .cart-item {
        background: var(--white);
        padding: 25px;
        border-radius: 20px;
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        align-items: center;
        gap: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        border: 1px solid rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
      }
      .cart-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(4, 75, 171, 0.15);
        border-color: rgba(4, 75, 171, 0.1);
      }

      .item-icon {
        width: 70px;
        height: 70px;
        background: #eff6ff;
        border-radius: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.8rem;
        color: var(--primary-blue);
      }

      .item-info h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 5px;
      }
      .item-info p {
        font-size: 0.9rem;
        color: var(--text-light);
      }

      .item-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-dark);
      }

      .btn-remove {
        color: #cbd5e1;
        cursor: pointer;
        transition: 0.3s;
        font-size: 1.1rem;
        background: none;
        border: none;
        padding: 10px;
      }
      .btn-remove:hover {
        color: var(--danger);
        transform: scale(1.2) rotate(10deg);
      }

      /* RESUMEN DE PAGO */
      .cart-summary {
        background: var(--white);
        padding: 30px;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 120px;
        height: fit-content;
      }
      .summary-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 25px;
        border-bottom: 2px solid #f1f5f9;
        padding-bottom: 15px;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        color: var(--text-light);
        font-size: 0.95rem;
      }
      .summary-row.total {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px dashed #e2e8f0;
        color: var(--text-dark);
        font-weight: 800;
        font-size: 1.4rem;
      }
      .summary-row.discount {
        color: var(--success);
        display: none;
        font-weight: 600;
      }

      /* CUPÓN */
      .coupon-box {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
      }
      .coupon-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #f1f5f9;
        border-radius: 12px;
        outline: none;
        font-family: inherit;
        transition: 0.3s;
      }
      .coupon-input:focus {
        border-color: var(--primary-blue);
        background: #f8fbff;
      }
      .btn-apply {
        background: var(--text-dark);
        color: var(--white);
        border: none;
        padding: 0 20px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
      }
      .btn-apply:hover {
        background: var(--primary-blue);
        transform: translateY(-2px);
      }

      /* BOTÓN PAGO */
      .btn-checkout {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #009ee3 0%, #0073a5 100%);
        color: var(--white);
        border: none;
        border-radius: 14px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        box-shadow: 0 10px 25px rgba(0, 158, 227, 0.3);
        text-decoration: none;
      }
      .btn-checkout:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(0, 158, 227, 0.4);
      }

      /* EMPTY STATE */
      .empty-cart {
        grid-column: 1 / -1;
        text-align: center;
        padding: 80px 20px;
        background: var(--white);
        border-radius: 24px;
        display: none;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
      }
      .btn-shop {
        display: inline-block;
        margin-top: 20px;
        padding: 12px 35px;
        background: var(--primary-blue);
        color: var(--white);
        text-decoration: none;
        border-radius: 50px;
        font-weight: 700;
        transition: 0.3s;
        box-shadow: 0 10px 20px rgba(4, 75, 171, 0.3);
      }
      .btn-shop:hover {
        background: var(--primary-dark);
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(4, 75, 171, 0.4);
      }

      @keyframes fadeDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* FOOTER */
      footer {
        background: linear-gradient(
          to bottom,
          var(--primary-blue),
          var(--primary-dark)
        );
        color: var(--white);
        padding: 4rem 5% 2rem;
        text-align: center;
        margin-top: auto;
      }
      .copyright {
        opacity: 0.7;
        font-size: 0.95rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 20px;
      }

      .menu-toggle {
        display: none;
        font-size: 1.5rem;
        color: var(--white);
        cursor: pointer;
        margin-right: 20px;
      }

      @media (max-width: 900px) {
        .cart-section {
          grid-template-columns: 1fr;
        }
        .cart-summary {
          position: static;
        }
      }
      @media (max-width: 768px) {
        .menu-toggle {
          display: block;
        }
        .nav-links {
          position: fixed;
          top: 0;
          right: -100%;
          height: 100vh;
          width: 100%;
          background: rgba(4, 75, 171, 0.98);
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 2.5rem;
          transition: 0.4s;
          z-index: 999;
        }
        .nav-links.active {
          right: 0;
        }
        nav {
          background: var(--primary-blue);
          align-items: center;
        }
        .logo-img {
          height: 60px;
        }
        .cart-item {
          grid-template-columns: 1fr auto;
          text-align: center;
          justify-items: center;
          padding: 20px;
        }
        .item-icon {
          margin-bottom: 10px;
        }
        .cart-item {
          display: flex;
          flex-direction: column;
          text-align: center;
        }
        .btn-remove {
          position: absolute;
          top: 15px;
          right: 15px;
          color: var(--danger);
          background: #fee2e2;
          border-radius: 50%;
          padding: 8px;
          width: 35px;
          height: 35px;
          display: flex;
          justify-content: center;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <nav id="navbar">
      <a href="index.html" class="logo">
        <img src="img/logo.png" alt="Logo" class="logo-img" />
      </a>
      <div class="nav-right">
        <ul class="nav-links">
          <li><a href="index.html">Inicio</a></li>
          <li><a href="catalogo.html">Catálogo</a></li>
          <li><a href="contacto.html">Contacto</a></li>
        </ul>
        <a href="carrito.html" class="cart-wrapper">
          <i class="fas fa-shopping-cart"></i>
          <span class="cart-count" id="cart-count">0</span>
        </a>
        <div class="menu-toggle"><i class="fas fa-bars"></i></div>
      </div>
    </nav>

    <header class="page-header">
      <h1 class="page-title">Tu Carrito</h1>
      <p class="page-subtitle">
        Estás a un paso de potenciar tu futuro profesional.
      </p>
    </header>

    <section class="cart-section">
      <div class="cart-items" id="cartItemsContainer"></div>

      <div class="empty-cart" id="emptyCartMessage">
        <i
          class="fas fa-shopping-basket"
          style="font-size: 5rem; color: #cbd5e1; margin-bottom: 20px"
        ></i>
        <h2
          style="font-size: 2rem; margin-bottom: 10px; color: var(--text-dark)"
        >
          Tu carrito está vacío
        </h2>
        <p style="color: var(--text-light); margin-bottom: 30px">
          Parece que aún no has elegido tu plan de éxito.
        </p>
        <a href="catalogo.html" class="btn-shop">Ver Catálogo</a>
      </div>

      <aside class="cart-summary" id="cartSummary">
        <h2 class="summary-title">Resumen del Pedido</h2>

        <div class="coupon-box">
          <input
            type="text"
            id="couponInput"
            class="coupon-input"
            placeholder="Código promocional"
          />
          <button class="btn-apply" onclick="applyCoupon()">Aplicar</button>
        </div>

        <div class="summary-row">
          <span>Subtotal</span>
          <span id="subtotalPrice">$0</span>
        </div>
        <div class="summary-row discount" id="discountRow">
          <span>Descuento <small id="discountName"></small></span>
          <span id="discountAmount">-$0</span>
        </div>

        <div class="summary-row total">
          <span>Total</span>
          <span id="totalPrice" style="color: var(--primary-blue)">$0</span>
        </div>

        <a
          href="#"
          class="btn-checkout"
          onclick="proceedToCheckout(); return false;"
        >
          Pagar con Mercado Pago <i class="fas fa-lock"></i>
        </a>
        <div
          style="
            text-align: center;
            margin-top: 15px;
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
          "
        >
          <i class="fas fa-shield-alt" style="color: var(--success)"></i> Pago
          100% Seguro y Encriptado
        </div>
      </aside>
    </section>

    <footer>
      <div class="copyright">
        &copy; 2025 CvArg. Todos los derechos reservados.
      </div>
    </footer>

    <script>
      // --- CONFIGURACIÓN ---
      // Pega aquí la URL de tu Google Apps Script desplegado como Web App
      const SCRIPT_URL = "PEGAR_TU_URL_DE_APPS_SCRIPT_AQUI";

      // Navbar Scroll
      window.addEventListener("scroll", function () {
        var navbar = document.getElementById("navbar");
        if (window.scrollY > 50) navbar.classList.add("scrolled");
        else navbar.classList.remove("scrolled");
      });

      // Menu Mobile
      const menuToggle = document.querySelector(".menu-toggle");
      const navLinks = document.querySelector(".nav-links");
      menuToggle.addEventListener("click", () => {
        navLinks.classList.toggle("active");
        const icon = menuToggle.querySelector("i");
        icon.classList.toggle("fa-bars");
        icon.classList.toggle("fa-times");
      });

      // --- LÓGICA DEL CARRITO ---
      let currentDiscount = 0;
      const VALID_COUPONS = { DESPEGAR10: 0.1, CVPRO: 0.2, STUDENT: 0.15 };

      document.addEventListener("DOMContentLoaded", () => {
        renderCart();
      });

      function renderCart() {
        const cart = JSON.parse(localStorage.getItem("impulsopro_cart")) || [];
        const container = document.getElementById("cartItemsContainer");
        const summary = document.getElementById("cartSummary");
        const emptyMsg = document.getElementById("emptyCartMessage");
        const badge = document.getElementById("cart-count");

        // Actualizar Badge
        let totalQty = cart.reduce((acc, item) => acc + item.quantity, 0);
        if (badge) {
          badge.innerText = totalQty;
          badge.style.display = totalQty === 0 ? "none" : "flex";
        }

        // Estado Vacío vs Lleno
        if (cart.length === 0) {
          container.style.display = "none";
          summary.style.display = "none";
          emptyMsg.style.display = "block";
          return;
        } else {
          container.style.display = "flex";
          summary.style.display = "block";
          emptyMsg.style.display = "none";
        }

        container.innerHTML = "";
        let subtotal = 0;

        cart.forEach((item, index) => {
          const itemTotal = item.price * item.quantity;
          subtotal += itemTotal;

          let iconClass = "fas fa-star";
          const nameLower = item.name.toLowerCase();
          if (nameLower.includes("cv")) iconClass = "fas fa-file-contract";
          else if (nameLower.includes("linkedin"))
            iconClass = "fab fa-linkedin";
          else if (
            nameLower.includes("web") ||
            nameLower.includes("portafolio")
          )
            iconClass = "fas fa-laptop-code";
          else if (nameLower.includes("traduccion"))
            iconClass = "fas fa-language";

          const html = `
                    <div class="cart-item" style="animation: fadeUp 0.5s ease backwards ${
                      index * 0.1
                    }s;">
                        <div class="item-icon"><i class="${iconClass}"></i></div>
                        <div class="item-info">
                            <h3>${item.name}</h3>
                            <p>Servicio Profesional Digital</p>
                        </div>
                        <div class="item-price">$${itemTotal}</div>
                        <button class="btn-remove" onclick="removeItem(${index})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
          container.innerHTML += html;
        });

        updateTotals(subtotal);
      }

      function updateTotals(subtotal) {
        const discountAmount = subtotal * currentDiscount;
        const total = subtotal - discountAmount;

        document.getElementById("subtotalPrice").innerText = `$${subtotal}`;
        document.getElementById("totalPrice").innerText = `$${total.toFixed(
          0
        )}`;

        const discountRow = document.getElementById("discountRow");
        if (currentDiscount > 0) {
          discountRow.style.display = "flex";
          document.getElementById(
            "discountAmount"
          ).innerText = `-$${discountAmount.toFixed(0)}`;
        } else {
          discountRow.style.display = "none";
        }
      }

      function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem("impulsopro_cart")) || [];
        cart.splice(index, 1);
        localStorage.setItem("impulsopro_cart", JSON.stringify(cart));
        renderCart();
      }

      function applyCoupon() {
        const input = document.getElementById("couponInput");
        const code = input.value.trim().toUpperCase();

        if (VALID_COUPONS[code]) {
          currentDiscount = VALID_COUPONS[code];
          document.getElementById("discountName").innerText = `(${code})`;
          alert(`¡Cupón ${code} aplicado correctamente!`);
          renderCart();
        } else {
          alert("Cupón inválido o expirado.");
          currentDiscount = 0;
          renderCart();
        }
      }

      // --- INTEGRACIÓN MERCADO PAGO ---
      async function proceedToCheckout() {
        const btn = document.querySelector(".btn-checkout");
        const originalText = btn.innerHTML;
        const cart = JSON.parse(localStorage.getItem("impulsopro_cart")) || [];

        if (cart.length === 0) return;

        // UI Loading
        btn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Generando pago...';
        btn.style.opacity = "0.7";
        btn.style.pointerEvents = "none";

        // Formatear items para MP
        const items = cart.map((item) => ({
          title: item.name,
          quantity: item.quantity,
          currency_id: "ARS", // O "USD" según corresponda
          unit_price: item.price,
        }));

        // Payload
        const payload = {
          action: "create_preference",
          items: items,
        };

        try {
          // LLAMADA AL BACKEND (Google Apps Script)
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "cors", // Importante para Apps Script
            headers: { "Content-Type": "text/plain;charset=utf-8" }, // Truco para evitar preflight
            body: JSON.stringify(payload),
          });

          const data = await response.json();

          if (data.init_point) {
            // REDIRECCIÓN A MERCADO PAGO
            window.location.href = data.init_point;
          } else {
            throw new Error("No se recibió link de pago");
          }
        } catch (error) {
          console.error("Error:", error);
          alert(
            "Hubo un error al conectar con Mercado Pago. Por favor, intenta de nuevo."
          );
          btn.innerHTML = originalText;
          btn.style.opacity = "1";
          btn.style.pointerEvents = "auto";
        }
      }
    </script>
  </body>
</html>
